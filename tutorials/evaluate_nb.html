<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <meta name="generator" content="sphinx-5.3.0, furo 2022.09.29"/>
        <title>&lt;no title&gt; - CompressAIVision</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=d81277517bee4d6b0349d71bb2661d4890b5617c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #00aaee;
  --color-brand-content: #00aaee;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">CompressAIVision</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docker.html">Docker</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html">Fiftyone</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="fiftyone.html">Fiftyone and MongoDB</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html#cli-tutorial">CLI Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="cli_tutorial_1.html">1. Datasets and Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli_tutorial_2.html">2. Registering Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli_tutorial_3.html">3. MPEG-VCM Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli_tutorial_4.html">4. Evaluate Custom Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli_tutorial_5.html">5. Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli_tutorial_6.html">6. VTM benchmark generation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html#library-tutorial">Library Tutorial</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="download.html">1. Download Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="convert.html">2. Input file conversion</a></li>
<li class="toctree-l2"><a class="reference internal" href="detectron2.html">3. Run Detectron2</a></li>
<li class="toctree-l2"><a class="reference internal" href="detectron2.html#detectron2">3. Detectron2</a></li>
<li class="toctree-l2"><a class="reference internal" href="evaluate.html">4. Evaluate</a></li>
<li class="toctree-l2"><a class="reference internal" href="encdec.html">5. Creating an EncoderDecoder class</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Library API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../conversion/index.html">compressai_vision.conversion</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../evaluation/index.html">compressai_vision.evaluation</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../evaluation/pipeline/index.html">compressai_vision.evaluation.pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../evaluation/fo/index.html">compressai_vision.evaluation.fo</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">faq</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/InterDigitalInc/CompressAI-Vision">Github repository</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <p>In this tutorial we evaluate mAP values for a dataset with Detectron2
and a deep-learning encoding model from the CompressAI library. We also
show how to perform a baseline evaluation with VTM.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># common libs
import math, os, io, json, cv2, random, logging, pickle, datetime
import numpy as np
# torch
import torch
# images
from PIL import Image
import matplotlib.pyplot as plt
# compressai
from compressai.zoo import bmshj2018_factorized
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>## *** Detectron imports ***
import detectron2
from detectron2.utils.logger import setup_logger
setup_logger()

# import some common detectron2 utilities
from detectron2 import model_zoo
from detectron2.engine import DefaultPredictor
from detectron2.config import get_cfg
from detectron2.utils.visualizer import Visualizer
from detectron2.data import MetadataCatalog, DatasetCatalog
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># CompressAI-Vision
from compressai_vision.conversion import FO2DetectronDataset # convert fiftyone dataset to Detectron2 dataset
from compressai_vision.conversion import detectron251 # convert Detectron2 results to fiftyone format
from compressai_vision.evaluation.fo import annexPredictions # annex predictions from
from compressai_vision.evaluation.pipeline import CompressAIEncoderDecoder, VTMEncoderDecoder # a class that does encoding+decoding &amp; returns the transformed image &amp; bitrate
from compressai_vision.tools import confLogger, quickLog, getDataFile
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># fiftyone
import fiftyone as fo
import fiftyone.zoo as foz
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>device = &#39;cuda&#39; if torch.cuda.is_available() else &#39;cpu&#39;
print(device)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cpu</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>## MODEL A
model_name=&quot;COCO-Detection/faster_rcnn_X_101_32x8d_FPN_3x.yaml&quot;
## look here:
## https://github.com/facebookresearch/detectron2/blob/main/MODEL_ZOO.md#faster-r-cnn
## for the line that says X101-FPN --&gt; box AP is 43

## MODEL B
# model_name=&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># cfg encapsulates the model architecture &amp; weights, also threshold parameter, metadata, etc.
cfg = get_cfg()
cfg.MODEL.DEVICE=device
# load config from a file:
cfg.merge_from_file(model_zoo.get_config_file(model_name))
# DO NOT TOUCH THRESHOLD WHEN DOING EVALUATION:
# too big a threshold will cut the smallest values &amp; affect the precision(recall) curves &amp; evaluation results
# the default value is 0.05
# value of 0.01 saturates the results (they don&#39;t change at lower values)
# cfg.MODEL.ROI_HEADS.SCORE_THRESH_TEST = 0.5
# get weights
cfg.MODEL.WEIGHTS = model_zoo.get_checkpoint_url(model_name)
print(&quot;expected input colorspace:&quot;, cfg.INPUT.FORMAT)
print(&quot;loaded datasets:&quot;, cfg.DATASETS)
model_dataset=cfg.DATASETS.TRAIN[0]
print(&quot;model was trained with&quot;, model_dataset)
model_meta=MetadataCatalog.get(model_dataset)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expected</span> <span class="nb">input</span> <span class="n">colorspace</span><span class="p">:</span> <span class="n">BGR</span>
<span class="n">loaded</span> <span class="n">datasets</span><span class="p">:</span> <span class="n">PRECOMPUTED_PROPOSAL_TOPK_TEST</span><span class="p">:</span> <span class="mi">1000</span>
<span class="n">PRECOMPUTED_PROPOSAL_TOPK_TRAIN</span><span class="p">:</span> <span class="mi">2000</span>
<span class="n">PROPOSAL_FILES_TEST</span><span class="p">:</span> <span class="p">()</span>
<span class="n">PROPOSAL_FILES_TRAIN</span><span class="p">:</span> <span class="p">()</span>
<span class="n">TEST</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;coco_2017_val&#39;</span><span class="p">,)</span>
<span class="n">TRAIN</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;coco_2017_train&#39;</span><span class="p">,)</span>
<span class="n">model</span> <span class="n">was</span> <span class="n">trained</span> <span class="k">with</span> <span class="n">coco_2017_train</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># model_meta.thing_classes # check class labels this was trained with
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>predictor = DefaultPredictor(cfg)
</pre></div>
</div>
<p>Get a handle to the dataset created in previous notebooks:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># dataset = fo.load_dataset(&quot;mpeg-vcm-detection&quot;)
dataset = fo.load_dataset(&quot;mpeg-vcm-detection-dummy&quot;) # or use the dummy dataset for testing/debugging
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataset
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Name</span><span class="p">:</span>        <span class="n">mpeg</span><span class="o">-</span><span class="n">vcm</span><span class="o">-</span><span class="n">detection</span><span class="o">-</span><span class="n">dummy</span>
<span class="n">Media</span> <span class="nb">type</span><span class="p">:</span>  <span class="n">image</span>
<span class="n">Num</span> <span class="n">samples</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Persistent</span><span class="p">:</span>  <span class="kc">True</span>
<span class="n">Tags</span><span class="p">:</span>        <span class="p">[]</span>
<span class="n">Sample</span> <span class="n">fields</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span>              <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">ObjectIdField</span>
    <span class="n">filepath</span><span class="p">:</span>        <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">StringField</span>
    <span class="n">tags</span><span class="p">:</span>            <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">ListField</span><span class="p">(</span><span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">StringField</span><span class="p">)</span>
    <span class="n">metadata</span><span class="p">:</span>        <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">EmbeddedDocumentField</span><span class="p">(</span><span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">ImageMetadata</span><span class="p">)</span>
    <span class="n">positive_labels</span><span class="p">:</span> <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">EmbeddedDocumentField</span><span class="p">(</span><span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">Classifications</span><span class="p">)</span>
    <span class="n">negative_labels</span><span class="p">:</span> <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">EmbeddedDocumentField</span><span class="p">(</span><span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">Classifications</span><span class="p">)</span>
    <span class="n">detections</span><span class="p">:</span>      <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">EmbeddedDocumentField</span><span class="p">(</span><span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">Detections</span><span class="p">)</span>
    <span class="n">open_images_id</span><span class="p">:</span>  <span class="n">fiftyone</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">StringField</span>
</pre></div>
</div>
<p>Set some loglevels</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># loglev=logging.DEBUG
loglev=logging.INFO
quickLog(&quot;CompressAIEncoderDecoder&quot;, loglev)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Logger</span> <span class="n">CompressAIEncoderDecoder</span> <span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Get a list of labels in the dataset:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>classes = dataset.distinct(
    &quot;detections.detections.label&quot;
)
print(classes)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;airplane&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def per_class(results_obj):
    &quot;&quot;&quot;helper function: take fiftyone/openimagev6 results object &amp; spit
    out mAP breakdown as per class
    &quot;&quot;&quot;
    d = {}
    for class_ in classes:
        d[class_] = results_obj.mAP([class_])
    return d
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CompressAIEncoderDecoder</span></code> is a subclass of <code class="docutils literal notranslate"><span class="pre">EncoderDecoder</span></code>,
i.e. it’s a class that encodes an image, decodes it, and returns the
transformed (encoded+decoded) image and the bitrate of the encoded
image.</p>
<p>In particular <code class="docutils literal notranslate"><span class="pre">CompressAIEncoderDecoder</span></code> uses a CompressAI
encoder/decoder to achieve this.</p>
<p>You used <code class="docutils literal notranslate"><span class="pre">annexPredictions</span></code> in the previous notebook to push the
dataset through a Detectron2 predictor. Here, we provide it with an
additional parameter: an <code class="docutils literal notranslate"><span class="pre">EncoderDecoder</span></code> class that transforms the
image before the image is passed to the Detectron2 predictor.</p>
<p>We run the <code class="docutils literal notranslate"><span class="pre">bmshj2018_factorized</span></code> model over various quality
parameters:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>params=[1] # debugging
# params=[1,2,3,4,5,6,7,8]
</pre></div>
</div>
<p>Detectron prediction results are saved during the run into the fiftyone
(mongodb) database. Let’s define a unique name for the sample field
where the detectron results are saved:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>predictor_field=&#39;detectron-predictions&#39;
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>xs=[]; ys=[]; maps=[]; # bpp, mAP values, mAP(s) per class
results=[] # complete results
for i in params:
    net = bmshj2018_factorized(quality=i, pretrained=True).eval().to(device)
    enc_dec = CompressAIEncoderDecoder(net, device=device)
    # note the EncoderDecoder instance here:
    # before the predictor is used, the image is crunched through the encoding/decoding process &amp; the bitrate is recorded
    # you could substitute CompressAIEncoderDecoder with VTMEncoderDecoder if you&#39;d like to (see also the end of this tutorial)
    print(&quot;running the detector at&quot;, i)
    bpp = annexPredictions(predictor=predictor, fo_dataset=dataset, encoder_decoder=enc_dec, predictor_field=predictor_field)
    # .. now detectron&#39;s results are in each sample at the &quot;detectron-predictions&quot;  field
    res = dataset.evaluate_detections(
        predictor_field,
        gt_field=&quot;detections&quot;,
        method=&quot;open-images&quot;,
        pos_label_field=&quot;positive_labels&quot;,
        neg_label_field=&quot;negative_labels&quot;,
        expand_pred_hierarchy=False,
        expand_gt_hierarchy=False
    )
    results.append((i, bpp, res))
    # save to disk at each iteration as a backup just in case
    xs.append(bpp)
    ys.append(res.mAP())
    maps.append(per_class(res))
    with open(&quot;out.json&quot;,&quot;w&quot;) as f:
        f.write(json.dumps({
            &quot;bpp&quot; : xs,
            &quot;map&quot; : ys,
            &quot;map_per_class&quot; : maps
            }, indent=2))
print(&quot;ready!&quot;)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">running</span> <span class="n">the</span> <span class="n">detector</span> <span class="n">at</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">sampsa</span><span class="o">/</span><span class="n">silo</span><span class="o">/</span><span class="n">interdigital</span><span class="o">/</span><span class="n">venv_all</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python3</span><span class="mf">.8</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">torch</span><span class="o">/</span><span class="n">_tensor</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">575</span><span class="p">:</span> <span class="ne">UserWarning</span><span class="p">:</span> <span class="n">floor_divide</span> <span class="ow">is</span> <span class="n">deprecated</span><span class="p">,</span> <span class="ow">and</span> <span class="n">will</span> <span class="n">be</span> <span class="n">removed</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">future</span> <span class="n">version</span> <span class="n">of</span> <span class="n">pytorch</span><span class="o">.</span> <span class="n">It</span> <span class="n">currently</span> <span class="n">rounds</span> <span class="n">toward</span> <span class="mi">0</span> <span class="p">(</span><span class="n">like</span> <span class="n">the</span> <span class="s1">&#39;trunc&#39;</span> <span class="n">function</span> <span class="n">NOT</span> <span class="s1">&#39;floor&#39;</span><span class="p">)</span><span class="o">.</span> <span class="n">This</span> <span class="n">results</span> <span class="ow">in</span> <span class="n">incorrect</span> <span class="n">rounding</span> <span class="k">for</span> <span class="n">negative</span> <span class="n">values</span><span class="o">.</span>
<span class="n">To</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">current</span> <span class="n">behavior</span><span class="p">,</span> <span class="n">use</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rounding_mode</span><span class="o">=</span><span class="s1">&#39;trunc&#39;</span><span class="p">),</span> <span class="ow">or</span> <span class="k">for</span> <span class="n">actual</span> <span class="n">floor</span> <span class="n">division</span><span class="p">,</span> <span class="n">use</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">rounding_mode</span><span class="o">=</span><span class="s1">&#39;floor&#39;</span><span class="p">)</span><span class="o">.</span> <span class="p">(</span><span class="n">Triggered</span> <span class="n">internally</span> <span class="n">at</span>  <span class="o">../</span><span class="n">aten</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ATen</span><span class="o">/</span><span class="n">native</span><span class="o">/</span><span class="n">BinaryOps</span><span class="o">.</span><span class="n">cpp</span><span class="p">:</span><span class="mf">467.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sample:  1 / 1
Evaluating detections...
 100% |█████████████████████| 1/1 [13.8ms elapsed, 0s remaining, 72.7 samples/s]
ready!
</pre></div>
</div>
<p>After the evaluation we can (and should!) remove the detectron results
from the database:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataset.delete_sample_fields(predictor_field)
</pre></div>
</div>
<p>Load results</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>with open(&quot;out.json&quot;,&quot;r&quot;) as f:
    res=json.load(f)
print(res)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;bpp&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.10060123042505593</span><span class="p">],</span> <span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span> <span class="s1">&#39;map_per_class&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;airplane&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}]}</span>
</pre></div>
</div>
<p>In that loop over quality parameters above, you can substitute the
<code class="docutils literal notranslate"><span class="pre">CompressAIEncoderDecoder</span></code> with <code class="docutils literal notranslate"><span class="pre">VTMEncoderDecoder</span></code>in order to
produce the anchor/baseline results. Let’s first set some variables for
the VTM program:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># NOTE: set path_to_vtm_software
vtm_encoder_app=os.path.join(path_to_vtm_software, &quot;bin/EncoderAppStatic&quot;)
vtm_decoder_app=os.path.join(path_to_vtm_software, &quot;bin/DecoderAppStatic&quot;)
vtm_cfg=os.path.join(path_to_vtm_software, &quot;cfg/encoder_intra_vtm.cfg&quot;)
</pre></div>
</div>
<p>If you’d want to see what the VTM is doing exactly, enable debugging
output:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>loglev=logging.DEBUG
# loglev=logging.INFO
log=quickLog(&quot;VTMEncoderDecoder&quot;, loglev) # VTMEncoderDecoder
</pre></div>
</div>
<p>At each quality parameter in the loop, instantiate an
<code class="docutils literal notranslate"><span class="pre">VTMEncoderDecoder</span></code> instead:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>enc_dec = VTMEncoderDecoder(
    encoderApp=vtm_encoder_app,
    decoderApp=vtm_decoder_app,
    ffmpeg=&quot;ffmpeg&quot;,
    vtm_cfg=vtm_cfg,
    qp=47,
    cache=&quot;/tmp/bitstreams&quot;,
    scale=100,
    warn=True
)
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VTMEncoderDecoder</span> <span class="o">-</span> <span class="n">WARNING</span> <span class="o">-</span> <span class="n">folder</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">bitstreams</span><span class="o">/</span><span class="mi">100</span><span class="o">/</span><span class="mi">47</span> <span class="n">exists</span> <span class="n">already</span>
</pre></div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, InterDigital Communications, Inc.
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    </body>
</html>