version: 2

variables:

  exp_name: "_gen_bitstreams_v1"
  device: "cuda"
  CODEC_PARAMS: "++codec.encoder_config.feature_channel_suppression.rpn.coverage_thres=0.7" 

  input_dir: "/data/datasets/MPEG-FCVCM/vcm_testdata"
  output_dir: "/mnt/wekamount/scratch_fcvcm/eimran/runs"

  script_dir: "."
  config_name: "eval_cfp_codec"

run_oiv6_det:

  before_script:
    - cd "${script_dir}"

  script:
    - bash mpeg_cfp_oiv6_detection.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${CODEC_PARAMS}" "${config_name}"

  parallel:
    matrix:
      - qp: [7, 8, 9, 10, 11, 12]


  sbatch:
    begin: now
    reservation: deepvideo
    cpus-per-task: 2
    gpus-per-task: 1
    output: slurm_%x_%A_%N_%s.out

run_oiv6_seg:

  before_script:
    - cd "${script_dir}"
    
  script:
    - bash mpeg_cfp_oiv6_segmentation.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${CODEC_PARAMS}" "${config_name}"

  parallel:
    matrix:
      - qp: [7, 8, 9, 10, 11, 12]

  sbatch:
    begin: now
    reservation: deepvideo
    cpus-per-task: 2
    gpus-per-task: 1
    output: slurm_%x_%A_%N_%s.out

generate_csv:
  needs:
    - run_oiv6_det
    - run_oiv6_seg

  before_script:
    - cd "${script_dir}"

  script:
    - python ../../utils/mpeg_template_format.py --dataset OIV6 --result_path ${output_dir}/split-inference-image/cfp_codec${exp_name}/MPEGOIV6/

  sbatch:
    begin: now
    cpus-per-task: 1
    output: oiv6_result_%A.out
