version: 2

variables:

  exp_name: "_anchor"
  device: "cpu"

  input_dir: "/data/datasets/MPEG-FCM/fcm_testdata"
  output_dir: "/mnt/wekamount/scratch_fcvcm/runs"

  CONF_NAME: "eval_vtm"

  script_dir: "."

run_hieve_tracking_1:
  before_script:
    - cd "${script_dir}"
  script:
    - bash mpeg_cfp_hieve.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${seq_name}" "${CONF_NAME}"
  parallel:
    matrix:
      - seq_name: [
            '13',
        ]
        qp: [20, 22, 24, 26, 28, 29]
  sbatch:
    begin: now
    mem-per-cpu: 32G
    cpus-per-task: 2
    gpus-per-task: 0
    output: slurm_%x_%A_%N_%s.out

run_hieve_tracking_1:
  before_script:
    - cd "${script_dir}"
  script:
    - bash mpeg_cfp_hieve.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${seq_name}" "${CONF_NAME}"
  parallel:
    matrix:
      - seq_name: [
            '16',
        ]
        qp: [22, 24, 26, 28, 30, 31]
  sbatch:
    begin: now
    mem-per-cpu: 32G
    cpus-per-task: 2
    gpus-per-task: 0
    output: slurm_%x_%A_%N_%s.out

run_hieve_tracking_1:
  before_script:
    - cd "${script_dir}"
  script:
    - bash mpeg_cfp_hieve.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${seq_name}" "${CONF_NAME}"
  parallel:
    matrix:
      - seq_name: [
            '2',
        ]
        qp: [22, 25, 27, 29, 31, 34]
  sbatch:
    begin: now
    mem-per-cpu: 32G
    cpus-per-task: 2
    gpus-per-task: 0
    output: slurm_%x_%A_%N_%s.out

run_hieve_tracking_1:
  before_script:
    - cd "${script_dir}"
  script:
    - bash mpeg_cfp_hieve.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${seq_name}" "${CONF_NAME}"
  parallel:
    matrix:
      - seq_name: [
            '17',
        ]
        qp: [22, 23, 24, 26, 27, 28]
  sbatch:
    begin: now
    mem-per-cpu: 32G
    cpus-per-task: 2
    gpus-per-task: 0
    output: slurm_%x_%A_%N_%s.out

run_hieve_tracking_1:
  before_script:
    - cd "${script_dir}"
  script:
    - bash mpeg_cfp_hieve.sh "${input_dir}" "${output_dir}" "${exp_name}" "${device}" "${qp}" "${seq_name}" "${CONF_NAME}"
  parallel:
    matrix:
      - seq_name: [
            '18',
        ]
        qp: [122, 25, 27, 29, 31, 34]
  sbatch:
    begin: now
    mem-per-cpu: 32G
    cpus-per-task: 2
    gpus-per-task: 0
    output: slurm_%x_%A_%N_%s.out


generate_csv:
  needs:
    - run_hieve_tracking_1
    - run_hieve_tracking_2
    - run_hieve_tracking_3
    - run_hieve_tracking_4
    - run_hieve_tracking_5

  before_script:
    - cd "${script_dir}"

  script:
    - python ../../utils/mpeg_template_format.py --dataset HIEVE --result_path ${output_dir}/split-inference-video/cfp_codec${exp_name}/MPEGHIEVE/

  sbatch:
    begin: now
    cpus-per-task: 1
    output: hieve_result_%A.out
