version: 2

variables:

  exp_name: "_gen_bitstreams_v1"
  device: "cuda"

  input_dir: "/data/datasets/MPEG-FCVCM/vcm_testdata"
  output_dir: "/mnt/wekamount/scratch_fcvcm/eimran/runs/"

  script_dir: "../cross_checking_scripts"

run_sfu_det:

  before_script:
    - cd "${script_dir}"

  script:
    - bash mpeg_cfp_sfu.sh ${input_dir} ${output_dir} ${exp_name} ${device} "${qp}" "${seq_name}"

  parallel:
    matrix:
      - seq_name: [      
              'Traffic_2560x1600_30_val',
              'Kimono_1920x1080_24_val',
              'ParkScene_1920x1080_24_val',
              'Cactus_1920x1080_50_val',
              'BasketballDrive_1920x1080_50_val',
              'BQTerrace_1920x1080_60_val',
              'BasketballDrill_832x480_50_val',
              'BQMall_832x480_60_val',
              'PartyScene_832x480_50_val',
              'RaceHorses_832x480_30_val',
              'BasketballPass_416x240_50_val',
              'BQSquare_416x240_60_val',
              'BlowingBubbles_416x240_50_val',
              'RaceHorses_416x240_30_val'
        ]
        qp: [5, 6, 7, 8, 9, 10]


  sbatch:
    begin: now
    reservation: deepvideo
    cpus-per-task: 2
    gpus-per-task: 1
    output: slurm_%x_%A_%N_%s.out

generate_csv:
  needs:
    - run_sfu_det

  before_script:
    - cd "${script_dir}"

  script:
    - python ../utils/mpeg_template_format.py --dataset SFU --result_path ${output_dir}/split-inference-video/cfp_codec${exp_name}/SFUHW/

  sbatch:
    begin: now
    cpus-per-task: 1
    output: sfu_result_%A.out
